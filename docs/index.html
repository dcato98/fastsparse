---

title: FastSparse


keywords: fastai
sidebar: home_sidebar

summary: "Customizable Fastai+PyTorch implementation of sparse model training methods (SET, SNFS, RigL)."
description: "Customizable Fastai+PyTorch implementation of sparse model training methods (SET, SNFS, RigL)."
nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Warning:-this-repo-is-undergoing-active-development"><em>Warning: this repo is undergoing active development</em><a class="anchor-link" href="#Warning:-this-repo-is-undergoing-active-development"> </a></h2><p>TODOs:</p>
<ul>
<li>test dynamic training callback</li>
<li>finish documenting this page<ul>
<li>PyTorch example</li>
<li>under-the-hood explanation</li>
<li>fully custom example</li>
<li>Drop/Redist/Grow criterion</li>
</ul>
</li>
<li>implement distributed training (?)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install fastsparse</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Fastai-example">Fastai example<a class="anchor-link" href="#Fastai-example"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With this package, you can train your model using the latest dynamic sparse training techniques. It only takes 4 additional lines of code!</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastsparse.core</span> <span class="kn">import</span> <span class="o">*</span>                            <span class="c1"># &lt;-- import this package</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST</span><span class="p">)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sparse_hooks</span> <span class="o">=</span> <span class="n">sparsify_model</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span> <span class="c1"># &lt;-- initial sparsity + enforce masks</span>
<span class="n">cbs</span> <span class="o">=</span> <span class="n">DynamicSparseTrainingCallback</span><span class="p">(</span><span class="o">**</span><span class="n">RigL_kwargs</span><span class="p">)</span>       <span class="c1"># &lt;-- dynamic mask updates</span>

<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">sparse_hooks</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>                        <span class="c1"># &lt;-- stop enforcing masks</span>
</pre></div>
<p>Simply omit the <a href="/fastsparse/core.html#DynamicSparseTrainingCallback"><code>DynamicSparseTrainingCallback</code></a> to train a fixed-sparsity model as a baseline.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="PyTorch-example">PyTorch example<a class="anchor-link" href="#PyTorch-example"> </a></h3><p>TODO</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-with-Large-Batch-Sizes">Training with Large Batch Sizes<a class="anchor-link" href="#Training-with-Large-Batch-Sizes"> </a></h3><p>Authors of the Rigged Lottery paper hypothesize that the effectiveness of using the gradient magnitude for determining which connections to grow is partly due to their large batch size (4096 for ImageNet). Those without access to multi-gpu clusters can achieve effective batch sizes of this size by using fastai's <code>GradientAccumulation</code> callback, which has been tested to be compatible with this package's <a href="/fastsparse/core.html#DynamicSparseTrainingCallback"><code>DynamicSparseTrainingCallback</code></a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Under-The-Hood">Under-The-Hood<a class="anchor-link" href="#Under-The-Hood"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here's what's going on.</p>
<p>When you run <code>sparsify_model(learn.model, 0.9)</code>, this adds sparse masks and add pre_forward hooks to enforce masks on weights during forward pass.</p>
<blockquote><p>By default, a uniform sparsity distribution is used. Change the sparsity distribution to Erdos-Renyi with <code>sparsify_model(learn.model, 0.9, sparse_init_f=erdos_renyi)</code>, or pass in your custom function (see <a href="#Customization">Customization</a></p>
<p>To avoid adding pre_forward hooks, use <code>sparsify_model(learn.model, 0.9, enforce_masks=False)</code>.</p>
</blockquote>
<p>When you add the <a href="/fastsparse/core.html#DynamicSparseTrainingCallback"><code>DynamicSparseTrainingCallback</code></a> callback, ... TODO complete section</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Customization">Customization<a class="anchor-link" href="#Customization"> </a></h2><p>There are several places to modify the behavior of fastsparse to accomplish custom behaviors. For an example, check out the implementation of RigL.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.-Initial-sparsity-distribution:">1. Initial sparsity distribution:<a class="anchor-link" href="#1.-Initial-sparsity-distribution:"> </a></h3><p>Define your own initial sparsity distribution by setting <code>sparsify_method</code> in <a href="/fastsparse/core.html#sparsify_model"><code>sparsify_model</code></a> to a custom function. For example, this function (included in library) makes the first layer dense, and all following layers to a fixed sparsity.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">first_layer_dense_uniform</span><span class="p">(</span><span class="n">params</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">model_sparsity</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
    <span class="n">sparsities</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">model_sparsity</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sparsities</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.-Drop-Criterion">2. Drop Criterion<a class="anchor-link" href="#2.-Drop-Criterion"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.-Redistribute-Criterion">3. Redistribute Criterion<a class="anchor-link" href="#3.-Redistribute-Criterion"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.-Grow-Criterion">4. Grow Criterion<a class="anchor-link" href="#4.-Grow-Criterion"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>...</p>

</div>
</div>
</div>
</div>
 

